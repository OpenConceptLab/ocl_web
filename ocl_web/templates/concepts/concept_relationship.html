{% extends "concepts/concept_base.html" %}
{% load i18n %}
{% load ocl_tags %}
{% load bootstrap3 %}


{% block tab-content %}
<div ng-controller="ConceptRelationshipController">
	<div class="container" style="margin-top: 20px;">
		<div class="row">
			<div class="col-md-6">
                {% if concept.owner_type == 'Organization' %}
                    {% url 'concept-relationship' org=concept.owner source=concept.source concept=concept.id as concept_relationship_url %}
                {% else %}
                    {% url 'concept-relationship' user=concept.owner source=concept.source concept=concept.id as concept_relationship_url %}
                {% endif %}

				<form class="form" name="compare_relationship_form"
							  ng-submit="submitRelationshipForm(compare_relationship_form, '{{ concept_relationship_url }}')" method="get">
					<div class="form-group required">
						<label class="control-label required small">Sources</label>
						<select class="form-control" id="selected_source" name="selected_source" multiple="multiple" ng-model="selected_source">
							{% for source in all_sources %}
                                <option value="{{ source.id }}">{{ source.id }}/ {{ source.owner }}</option>
							{% endfor %}
						</select>
					</div>
					{% buttons %}
						<button type="submit" class="btn btn-primary btn-block">Submit</button>
					{% endbuttons %}
				</form>

                <!--<canvas id="springydemo" width="640" height="480" />-->

				<table>
					{% for mapping in mappings %}
					<tr>{{ mapping.id }}</tr><hr>
					{% endfor %}
				</table>
			</div>

            <!-- Concept Names, Descriptions, and Custom Attributes -->
		<div class="col-md-6">
			<div class="panel panel-default">

				<!-- Mappings -->
				<div class="panel-heading"><h3 class="panel-title">Mappings</h3></div>
				<div class="panel-body" style="overflow-x:scroll;">
				{% if concept.has_direct_mappings %}
					<table class="table table-striped">
						<thead>
							<tr>
								<th width="1">&nbsp;</th>
								<th>Relationship</th>
								<th>Source</th>
								<th>Code</th>
								<th>Name</th>
							</tr>
						</thead>
						<tbody>
						{% for mapping in mappings|dictsort:"map_type" %}
							{% if mapping.is_direct_mapping %}
								{% if mapping.to_source_owner_type == 'Organization' %}
									{% url 'org-home' org=mapping.to_source_owner as to_concept_owner_url %}
									{% url 'source-home' org=mapping.to_source_owner source=mapping.to_source_name as to_concept_source_url %}
									{% if mapping.is_internal_mapping %}
										{% url 'concept-home' org=mapping.to_source_owner source=mapping.to_source_name concept=mapping.to_concept_code as to_concept_url %}
									{% endif %}
								{% else %}
									{% url 'users:detail' mapping.to_source_owner as to_concept_owner_url %}
									{% url 'source-home' user=mapping.to_source_owner source=mapping.to_source_name as to_concept_source_url %}
									{% if mapping.is_internal_mapping %}
										{% url 'concept-home' user=mapping.to_source_owner source=mapping.to_source_name concept=mapping.to_concept_code as to_concept_url %}
									{% endif %}
								{% endif %}

							<tr>
								<td>{% if mapping.is_external_mapping %}<span class="glyphicon glyphicon-circle-arrow-right" title="External Mapping"></span>{% else %}&nbsp;{% endif %}</td>
								<td>{{ mapping.map_type }}</td>
								<td><a href="{{ to_concept_owner_url }}">{{ mapping.to_source_owner }}</a> / <a href="{{ to_concept_source_url }}">{{ mapping.to_source_name }}</a></td>
								<td>{% if mapping.is_internal_mapping %}<a href="{{ to_concept_url }}">{{ mapping.to_concept_code }}</a>{% else %}{{ mapping.to_concept_code }}{% endif %}</td>
								<td>{{ mapping.to_concept_name|default:"-" }}</td>
							</tr>
							{% endif %}
						{% endfor %}
						</tbody>
					</table>
				{% else %}
					<h3><small>No direct mappings</small></h3>
				{% endif %}
				</div>

				<!-- Inverse Mappings -->
				<div class="panel-heading"><h3 class="panel-title">Inverse Mappings</h3></div>
				<div class="panel-body" style="overflow-x:scroll;">
				{% if concept.has_inverse_mappings %}
					<table class="table table-striped">
						<thead>
							<tr>
								<th width="1">&nbsp;</th>
								<th>Relationship</th>
								<th>Source</th>
								<th>Code</th>
								<th>Name</th>
							</tr>
						</thead>
						<tbody>
						{% for mapping in mappings|dictsort:"map_type" %}
							{% if mapping.is_inverse_mapping %}
								{% if mapping.to_source_owner_type == 'Organization' %}
									{% url 'org-home' org=mapping.from_source_owner as from_concept_owner_url %}
									{% url 'source-home' org=mapping.from_source_owner source=mapping.from_source_name as from_concept_source_url %}
									{% url 'concept-home' org=mapping.from_source_owner source=mapping.from_source_name concept=mapping.from_concept_code as from_concept_url %}
								{% else %}
									{% url 'users:detail' mapping.from_source_owner as from_concept_owner_url %}
									{% url 'source-home' user=mapping.from_source_owner source=mapping.from_source_name as from_concept_source_url %}
									{% url 'concept-home' user=mapping.from_source_owner source=mapping.from_source_name concept=mapping.from_concept_code as from_concept_url %}
								{% endif %}

							<tr>
								<td>{% if mapping.is_external_mapping %}<span class="glyphicon glyphicon-circle-arrow-right" title="External Mapping"></span>{% else %}&nbsp;{% endif %}</td>
								<td>{{ mapping.map_type }}</td>
								<td><a href="{{ from_concept_owner_url }}">{{ mapping.from_source_owner }}</a> / <a href="{{ from_concept_source_url }}">{{ mapping.from_source_name }}</a></td>
								<td><a href="{{ from_concept_url }}">{{ mapping.from_concept_code }}</a></td>
								<td>{{ mapping.from_concept_name|default:"-" }}</td>
							</tr>
							{% endif %}
						{% endfor %}
						</tbody>
					</table>
				{% else %}
					<h3><small>No inverse mappings</small></h3>
				{% endif %}
				</div>


				<div class="panel-footer small"><em>* Only mappings defined in this source are displayed here</em></div>
			</div>
		</div>
		</div>
	<!--</div>-->
<!--</div>-->
{% endblock tab-content %}


{% block resource-debug %}
<h4>URL kwargs</h4><pre>{{ kwargs|pprint }}</pre>
<h4>URL Parameters</h4><pre>{{ url_params|pprint }}</pre>
<h4>Concept</h4><pre>{{ concept|pprint }}</pre>
<h4>Mappings</h4><pre>{{ mappings|pprint }}</pre>
{% endblock resource-debug %}


{% block extrajavascript %}
<script type="text/javascript">

    $(document).ready(function() {
        $('#selected_source').multiselect();

//        var mappings = {{ mappings | safe }};

//        var graph = new Springy.Graph();
//
//        for(var i=0; i<mappings.length; i++){
//            graph.addNodes(mappings[i].id);
//        }
//
//        alert(mappings.length);
//
//        for(var i=0; i<mappings.length; i++){
//            for(var j=i; j<mappings.length; j++){
//                graph.addEdges([mappings[i].id, mappings[j].id, {color: '#00A0B0', label: 'Foo bar'}]);
//            }
//        }
//
//
//        jQuery(function(){
//          var springy = jQuery('#springydemo').springy({
//            graph: graph
//          });
//        });

    });

</script>
{% endblock extrajavascript %}
