{% extends "sources/source_base.html" %}
{% load i18n %}
{% load ocl_tags %}
{% load bootstrap3 %}
{% load humanize %}


{% block tab-content %}
<div class="container-fluid">
<div class="row" ng-controllerx="SourceSearchController">
	<form action="." method="get">

	<!-- Start left column -->
	<div class="col-sm-3 hidden-xs">

		<!-- Search Filters -->
		<div role="form">
			{% for search_filter in search_filters %}
			<div class="filter-group">
				<div class="filter-group-header">{{ search_filter.filter_name }}</div>
				<div class="filter-group-body">
					{% for filter_option in search_filter.options %}
						{% if filter_option.option_num > 0 or search_filter.attrs.show_zeroed_options %}
							<div class="checkbox"><label>{% if not search_filter.attrs.hide_numbers %}<span class="count">{{ filter_option.option_num|intcomma }}</span>{% endif %}<input type="checkbox" name="{{ search_filter.filter_id }}" value="{{ filter_option.option_value }}" {% if filter_option.selected %}checked{% endif %}>{{ filter_option.option_name }}</label></div>
						{% endif %}
					{% endfor %}
				</div>
			</div>
			{% endfor %}
		</div>

	<!-- End left column -->
	</div>

	<!-- Start right column: Search results section -->
	<div class="col-sm-9">

		<!-- Search Bar, Actions, Sorting and Paging -->
		<div class="row" style="margin-bottom:10px;margin-top:10px;">
			<div class="col-md-12">
				{% if request.user.is_authenticated %}
				<!-- Add to collection button -->
				<div class="pull-left" style="margin-left:-15px;">
					{% select_all_toggle checkbox_css_selector='.search-result-checkbox' data_table_rows_id='data-table-rows' %}
					<div class="btn-group" id="add-to-collection-dropdown" style="margin-left:5px; margin-right:5px">
						<button type="button" id="add-to-collection-dropdown-button" class="btn btn-block btn-sm btn-default dropdown-toggle transparent disabled" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Add to Collection <span class="caret"></span></button>
						<div class="collection-list-dropdown dropdown-menu">
							{% if not all_collections %}
							<div class="no-collections-info-box">
								<span>You do not have any existing collections. Create a collection in your profile.</span>
							</div>
							{% else %}
							<div class="collection-list-container">
								{% for collection in all_collections %}
								<div class="{% if collection.owner_type == 'Organization' %}org-collection-radio {% endif %}collection-radio radio">
									<label>
										<input type="radio" name="collections" id="user-collection-{{ forloop.counter }}" value="{{ forloop.counter }}" >
										<input type="hidden" name="collection-owner" id="collection-owner-{{ forloop.counter }}" value="{{ collection.owner }}">
										<input type="hidden" name="collection-name" id="collection-name-{{ forloop.counter }}" value="{{ collection.id }}">
										<input type="hidden" name="collection-url" id="collection-url-{{ forloop.counter }}" value="{{ collection.url }}">
										{{ collection.owner }} / <strong>{{ collection.id }}</strong>
									</label>
								</div>
								{% endfor %}
							</div>
							<button type="button" class="add-to-collection-save btn btn-primary btn-block" disabled="disabled">Save</button>
							{% endif %}
						</div>
					</div>
				</div>
				{% endif %}

				{% if results %}
				<!-- Simple Pager -->
				{% simple_pager current_page 'concept' url=pagination_url pager_size='small' hide_xs=1 %}
				{% endif %}

				{% if results %}
				<!-- Sort By Dropdown -->
				<div class="hidden-xs btn-group pull-right" style="margin-right:8px;">
					<button type="button" class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown" aria-expanded="false"><span class="glyphicon glyphicon-sort"></span> <span class="caret"></span></button>
					<ul class="dropdown-menu" role="menu">
					{% for sort_option_def in search_sort_option_defs %}
						{% if source.owner_type == 'Organization' %}
							{% if kwargs and "source_version" in kwargs %}
								{% url 'source-version-concepts' org=source.owner source=source.id source_version=kwargs.source_version as source_concepts_url %}
							{% else %}
								{% url 'source-concepts' org=source.owner source=source.id as source_concepts_url %}
							{% endif %}
						{% else %}
							{% if kwargs and "source_version" in kwargs %}
								{% url 'source-version-concepts' user=source.owner source=source.id source_version=kwargs.source_version as source_concepts_url %}
							{% else %}
								{% url 'source-concepts' org=source.owner source=source.id as source_concepts_url %}
							{% endif %}
						{% endif %}
						<li {% if search_sort == sort_option_def.value %}class="active"{% endif %}><a href="{{ source_concepts_url }}?{{ transferrable_search_params }}&amp;sort={{ sort_option_def.value|urlencode }}"><span class="glyphicon {{ sort_option_def.icon }}"></span>&nbsp;{{ sort_option_def.display }}</a></li>
					{% endfor %}
					</ul>
				</div>
				{% endif %}

				{% if results %}
					<!-- Search results download -->
					{% include "download_csv.html" with type='repository_search' %}
				{% endif %}

				<!-- Exact match checkbox (always render, but hide on xs display) -->
				<div class="hidden-xs btn-group pull-right" style="padding-left:4px;margin-top:6px;margin-right:8px;">
					<label for="exact_match_repository_search" style="font-weight:300;cursor:pointer;">
						<input name="exact_match" type="checkbox" tooltip="Exact match" {% if request.GET.exact_match %}checked="checked"{% endif %} id="exact_match_repository_search" style="cursor:pointer;" />
						<span class="small">Exact match</span>
					</label>
				</div>

				{% if_can_change source %}
					{% if kwargs.source_version == 'HEAD' or kwargs.source_version == None %}
						<!-- New Concept Button -->
						{% if source.owner_type == 'Organization' %}
							{% url 'concept-new' org=source.owner source=source.id as new_resource_url %}
						{% else %}
							{% url 'concept-new' user=source.owner source=source.id as new_resource_url %}
						{% endif %}
						<div class="pull-left">
							<a class="btn btn-link btn-sm" id="id-new-concept" style="font-weight:300;letter-spacing:-0.1pt;" href="{{ new_resource_url }}" title="Add New Concept to Source"><span class="glyphicon glyphicon-plus"></span><span class="hidden-xs">&nbsp;{% trans 'New Concept' %}</span></a>
						</div>
					{% endif %}
				{% endif_can_change source %}

				<!-- Source Concepts Search (always show) -->
				<div class="input-group input-group-sm" style="width:auto;margin-right:6px;">

					<!-- Source Version Dropdown -->
					<div class="input-group-btn">
						<button type="button" class="btn btn-default dropdown-toggle repo-version-selector" data-toggle="dropdown">
							<span class="pull-right"><span class="caret"></span></span>
							<span style="letter-spacing:-0.1pt;">
								<span class="text-muted" style="font-weight:300;">Source Version:</span>
								<span style="font-weight:400;">{% if source_version %}{{ source_version }}{% else %}HEAD{% endif %}</span>
							</span>
						</button>
						<ul class="dropdown-menu" role="menu">
						{% for source_version_i in source_versions %}
							{% if source.owner_type == 'Organization' %}
								{% url 'source-version-concepts' org=source.owner source=source.id source_version=source_version_i.id as source_version_i_url %}
							{% else %}
								{% url 'source-version-concepts' user=source.owner source=source.id source_version=source_version_i.id as source_version_i_url %}
							{% endif %}
							<li {% if source_version == source_version_i.id %}class="active"{% endif %}>
								<a href="{{ source_version_i_url }}">
									<span class="{% if source_version_i.retired %}repo-version-retired{% elif source_version_i.released %}repo-version-released{% endif %}">{{ source_version_i.id }}</span>
									{% if source_version_i.released and not source_version_i.retired %}<span class="text-muted">(Released)</span>{% endif %}
									{% if source_version_i.retired %}<span class="text-muted">(Retired)</span>{% endif %}
								</a>
							</li>
						{% endfor %}
						</ul>
					</div>

					<!-- Search input and submit button -->
					<input type="text" name="q" class="form-control" placeholder="Search concepts within source" value="{{ search_query }}">
					<span class="input-group-btn"><button class="btn btn-default" type="submit"><span class="glyphicon glyphicon-search"></span></button></span>
				</div><!-- /.input-group -->

			</div><!-- /.col-sm-12 -->
		</div><!-- /.row -->

		<div id="add-to-collection-result-information" style="margin-top: 12px;display: none;" class="alert alert-warning">Added the latest versions of concepts/mappings to the collections. Future updates will not be added automatically.</div>

		<!-- Search results -->
		<div id="data-table-rows">
{% for result in results %}
		<div class="row row-search-result">
			{% if source.owner_type == 'Organization' %}
				{% if kwargs.source_version == 'HEAD' or kwargs.source_version == None %}
					{% url 'concept-home' org=result.owner source=result.source concept=result.id as result_url %}
				{% else %}
					{% url 'concept-home-versioned' org=result.owner source=result.source concept=result.id concept_version=result.version as result_url %}
				{% endif %}
			{% else %}
				{% if kwargs.source_version == 'HEAD' or kwargs.source_version == None %}
					{% url 'concept-home' user=result.owner source=result.source concept=result.id as result_url %}
				{% else %}
					{% url 'concept-home-versioned' user=result.owner source=result.source concept=result.id concept_version=result.version as result_url %}
				{% endif %}
			{% endif %}

			<div class="pull-left search-result-col-checkbox" style="padding-left:10px">
				<span>
					<input class="search-result-checkbox" type="checkbox" name="reference" id="select-concept-{{ forloop.counter }}" />
				</span>
			</div>

			<!--div class="col-md-1 search-result-col-checkbox"><input type="checkbox" /></div-->
			<div class="hidden-xs col-sm-1 search-result-col-icon"><span class="glyphicon glyphicon-tag search-result-icon"></span></div>
			<div class="col-xs-11 col-sm-10 search-result-col-content">
				<div class="label-container" id="label-container-{{ forloop.counter }}">
					{% generic_resource_label resource_type='concept' resource_id=result.id resource_name=result.display_name resource_url=result_url resource_retired=result.retired owner_type=result.owner_type owner_id=result.owner source_id=result.source label_size='small' display_breadcrumb=True %}
				</div>
				<div class="resource-attributes"><span class="resource-attr"><label>Class:</label> {{ result.concept_class }}</span>, <span class="resource-attr"><label>Datatype:</label> {{ result.datatype }}</span></div>
				{% if result.description %}<div class="resource-description">{{ result.description }}</div>{% endif %}
				<div class="resource-metadata"><span class="glyphicon glyphicon-calendar"></span>&nbsp;&nbsp;Last updated on {{ result.updated_on|smart_date }}</div>
				{% if request.GET.debug %}<pre>{{ result|pprint }}</pre>{% endif %}
			</div>
		</div>
{% empty %}
		<h3><small>{% trans 'No concepts found' %}</small></h3>
{% endfor %}
		</div>

		<!-- Pagination -->
		{% if results %}
		<div class="row" style="text-align:center;">
			{% bootstrap_pagination current_page url=pagination_url %}
		</div>
		{% endif %}

	<!-- End right column: Search results section -->
	</div>

</form>
</div>
</div>
	<!-- /container-fluid -->
    <div class="modal fade" id="add-to-collection-confirm" role="dialog" tabindex="-1">
        <div class="modal-dialog expanded" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title">Add to Collection</h4>
                </div>
                <div class="modal-body">
                    <div class="panel panel-default">
                        <div class="panel-body">
                            <h5><strong id="number-of-selected-resources">-</strong> selected <span id="references-label">references</span> will be added to collection <strong id="collection-name">-</strong></h5>
                        </div>
                    </div>

                    <hr>

                    <div class="information-tooltip" style="margin: 10px 0;">
                        <label class="checkbox-inline" for="cascade-mappings">
                            <input type="checkbox" id="cascade-mappings" checked="checked">
                            Automatically add associated mappings
                        </label>
                        <button type="button" class="btn btn-question btn-circle" data-toggle="tooltip" data-placement="right" title="A concept's associated mappings are mappings that originate from the specified concept (the 'from concept') and that are stored in the same source"><strong>?</strong></button>
                    </div>

                </div>
                <div class="modal-footer">
                    <input type="button" class="btn btn-default" data-dismiss="modal" value="Close" id="close-modal"/>
                    <input type="button" class="btn btn-primary" data-dismiss="modal" value="Confirm" id="confirm-modal"/>
                </div>
            </div>
        </div>
    </div>

	<div class="modal fade" id="add-to-collection-error" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h3 class="modal-title">Add Reference</h3>
				</div>
				<div class="modal-body">
					<div id="addToCollectionModalErrorList">
						<div class="alert alert-warning">
							References listed below could not be added.
						</div>
						<ul class="list-group">
						</ul>
					</div>

					<div id="addToCollectionModalSuccessList" style="display: none">
						<div class="alert alert-success">
							Following references were added to the collection:
						</div>
						<ul class="list-group">
						</ul>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					<a id="closeErrorModalButton"
					   style="display: none"
					   class="btn btn-primary"
					   type="button">View all references</a>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

	<script>
        $(document).ready(function () {
            $('[data-toggle="tooltip"]').tooltip();

            var dropdown = $('#add-to-collection-dropdown-button');
            $(document).on('allUnchecked', function () {
                dropdown.addClass('transparent disabled');
            });
            $(document).on('someChecked', function () {
                dropdown.removeClass('transparent disabled');
            });

            $('.collection-list-dropdown div.radio, .collection-list-dropdown input').click(function(e){
                e.stopPropagation();

                if($('input[name="collections"]:checked').val()){
                    $('.add-to-collection-save').attr('disabled', false);
                }
            });

            $('.add-to-collection-save').click(function() {
                var selectedResources = $('input.search-result-checkbox:checked').length;
                if(selectedResources < 1) return;

                var selectedCollectionId = $('input[name="collections"]:checked').val();
                var selectedCollectionName = $('#collection-owner-' + selectedCollectionId).val() + ' / ' + $('#collection-name-' + selectedCollectionId).val();

                $('#add-to-collection-confirm').modal('show');
                $('#number-of-selected-resources').text(selectedResources);
                $('#references-label').text(selectedResources == 1 ? 'reference': 'references');
                $('#collection-name').text(selectedCollectionName);
            });

            $('#confirm-modal').click(function() {
                var selectedCollectionId = $('input[name="collections"]:checked').val();
                var selectedCollectionURI = $('#collection-url-' + selectedCollectionId).val();
                var postURL = selectedCollectionURI + 'references/new/?cascade=' + ($('#cascade-mappings:checkbox:checked').length > 0 ? 'sourcemappings' : 'none');

                var selectedResources = [];
                $('input.search-result-checkbox:checked').each(function () {
                    var checkboxId = $(this).attr('id').replace("select-concept-", "");
                    var selectedResource = $('#label-container-' + checkboxId + ' > a').attr('href');
                    selectedResources.push(selectedResource);
                });

                function clearSelection() {
                    $('#unselect-all-references')[0].click();
                }

                function resetModal() {
                    $('#closeErrorModalButton').hide();
                    $('#addToCollectionModalSuccessList > ul').html("");
                    $('#addToCollectionModalSuccessList').hide();
                    $('#addToCollectionModalErrorList > ul').html("");
                }

                function listSuccessfulAdditions(added) {
                    if (added.length < 1) {
                        $('#add-to-collection-result-information').hide();
                        return;
                    }

                    $('#closeErrorModalButton').show();
                    $('#closeErrorModalButton').attr("href", selectedCollectionURI + "references/");

                    $('#addToCollectionModalSuccessList').show();

                    added.forEach(function (addedReference) {
                        $('#addToCollectionModalSuccessList > ul').append("<li class='list-group-item'><strong>" + addedReference.expression + "</strong></li>");
                    });
                }

                $.ajax({
                    url:postURL,
                    type:"POST",
                    headers: {
                        'X-CSRFToken': $.cookie('csrftoken'),
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    data: JSON.stringify({
                        expressions: selectedResources
                    }),
                    contentType:"application/json; charset=utf-8",
                    dataType:"json"
                }).done(function (result) {
                    $('#add-to-collection-result-information').show();

                    clearSelection();
                    resetModal();

                    var errors = result.errors || result.update_results.filter(function (result) {
                            return !result.added;
                        });

                    if (errors.length < 1) return;
                    $('#add-to-collection-error').modal('show');

                    errors.forEach(function (error) {
                        $('#addToCollectionModalErrorList > ul').append("<li class='list-group-item'><strong>" + error.expression + ":</strong> " + error.message[0] + "</li>");
                    });

                    var added = result.update_results.filter(function (result) {
                        return result.added;
                    });
                    listSuccessfulAdditions(added);

                }).fail(function (jqXHR, textStatus) {
                    $('#add-to-collection-result-information').hide();
                });

            });
        });
    </script>
{% endblock tab-content %}


{% block resource-debug %}
<h4>URL kwargs</h4><pre>{{ kwargs|pprint }}</pre>
<h4>URL Parameters</h4><pre>{{ url_params|pprint }}</pre>
<h4>Source</h4><pre>{{ source|pprint }}</pre>
<h4>Search Results: Concepts</h4><pre>{{ results|pprint }}</pre>
<h4>Search Filters</h4><pre>{{ search_filters_debug|pprint }}</pre>
<h4>Search Facets</h4><pre>{{ search_facets_json|pprint }}</pre>
{% endblock resource-debug %}
